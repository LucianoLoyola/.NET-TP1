@page "/userprofile_new"
@rendermode InteractiveServer
@inject AgregarUsuarioUseCase agregarUsuario
@inject NavigationManager Navigation
@inject IServicioHash servicioHash

<h3>Nuevo Usuario</h3>
<form method="post" @onsubmit="AgregarUsuario">
    <div class="mb-3">
        <label for="UserName">Nombre de Usuario:</label>
        <input type="text" id="UserName" class="form-control" @bind="user.UserName" required />
    </div>
        <div class="mb-3">
        <label for="Email">Contraseña:</label>
        <input type="password" id="Contraseña" class="form-control" @bind="user.Password" required />
    </div>
    <div class="mb-3">
        <label for="Name">Nombre:</label>
        <input type="text" id="Name" class="form-control" @bind="user.Name" required />
    </div>
    <div class="mb-3">
        <label for="Surname">Apellido:</label>
        <input type="text" id="Surname" class="form-control" @bind="user.Surname" required />
    </div>
    <div class="mb-3">
        <label for="Email">Email:</label>
        <input type="email" id="Email" class="form-control" @bind="user.Email" required />
    </div>
    <div class="mb-3">
        <label for="Role">Rol:</label>
        <select id="Role" class="form-control" @bind="user.Role" required>
            <option value="Usuario">Usuario</option>
            <option value="Administrador">Administrador</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="Permisos">Permisos:</label>
        @foreach (TipoPermiso permiso in Enum.GetValues(typeof(TipoPermiso)))
        {
            <div>
                <input type="checkbox" id="permiso-@permiso" @onchange="e => TogglePermiso(permiso, e)" />
                <label for="permiso-@(permiso)">@(permiso)</label>
            </div>
        }
    </div>
    
        <button class="btn btn-primary" @onclick="AgregarUsuario">Agregar</button>
</form>
<br><br>
            <div class="mb-3 text-center">
                <span class="text-danger">@errorMessage</span>
                <span class="text-success">@successMessage</span>
            </div>


@code {
    [Parameter]
    public int UserId { get; set; }
    private List<TipoPermiso> permisosSeleccionados = new List<TipoPermiso>(); // Crear lista de permisos seleccionados
    private UserAccount user { get; set; } = new UserAccount();
    private void TogglePermiso(TipoPermiso permiso, ChangeEventArgs e)
    {
        if ((bool)e.Value) permisosSeleccionados.Add(permiso); // Agregar el permiso a la lista de permisos seleccionados
        else permisosSeleccionados.Remove(permiso); // Quitar el permiso de la lista de permisos seleccionados
    }

    private string? errorMessage,successMessage = "";
    void AgregarUsuario()
    {
        try{

            agregarUsuario.Ejecutar(user,permisosSeleccionados);
            Navigation.NavigateTo("/");

        }
        catch(AutorizacionException e){
            errorMessage=e.Message;
        }
        catch(ValidacionException e){
            errorMessage=e.Message;
        }
        catch(RepositorioException e){
            errorMessage=e.Message;
        }
    }

}